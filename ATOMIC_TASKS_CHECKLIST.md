# ProManage 原子化任务跟踪清单

**最后更新**: 2025-10-30  
**状态**: 🟡 进行中

---

## 📊 任务总览

| 任务组 | 总任务数 | 已完成 | 进行中 | 待开始 |
|--------|---------|--------|--------|--------|
| 任务组1: N+1重构 | 15 | 0 | 0 | 15 |
| 任务组2: WebSocket异常处理 | 6 | 0 | 0 | 6 |
| 任务组3: 日志审查 | 5 | 0 | 0 | 5 |
| **总计** | **26** | **0** | **0** | **26** |

---

# 🔴 任务组1: N+1查询重构（高优先级）

## ✅ 任务1.1: ChangeRequestController N+1重构

### Step 1.1.1: 分析现有代码结构
- [ ] 查找所有convert方法
- [ ] 统计getById调用次数
- [ ] 识别用户ID字段列表
- [ ] 创建分析报告
- **预计时间**: 30分钟
- **负责人**: ______
- **完成日期**: ______

### Step 1.1.2: 创建用户ID收集工具方法
- [ ] 创建collectUserIds方法
- [ ] 编写单元测试
- [ ] 处理null值情况
- [ ] 代码审查
- **预计时间**: 1小时
- **负责人**: ______
- **完成日期**: ______

### Step 1.1.3: 重构convertToChangeRequestResponse方法
- [ ] 修改方法签名（添加Map参数）
- [ ] 移除userService依赖
- [ ] 从Map中安全获取用户信息
- [ ] 更新所有调用方
- [ ] 编写单元测试
- **预计时间**: 2小时
- **负责人**: ______
- **完成日期**: ______

### Step 1.1.4: 重构调用方代码
- [ ] 在listChangeRequests中收集用户ID
- [ ] 批量获取用户Map
- [ ] 传递Map给转换方法
- [ ] 处理空列表情况
- [ ] 编写集成测试
- **预计时间**: 2小时
- **负责人**: ______
- **完成日期**: ______

### Step 1.1.5: 重构其他转换方法
- [ ] 重构convertToImpactResponse
- [ ] 重构convertToApprovalResponse
- [ ] 创建对应的ID收集方法
- [ ] 更新所有调用方
- [ ] 编写测试
- **预计时间**: 3小时
- **负责人**: ______
- **完成日期**: ______

### Step 1.1.6: 编写单元测试
- [ ] 测试convertToChangeRequestResponse
- [ ] 测试convertToImpactResponse
- [ ] 测试convertToApprovalResponse
- [ ] 测试批量查询逻辑
- [ ] 测试边界情况（null、空列表）
- [ ] 测试覆盖率≥90%
- **预计时间**: 2小时
- **负责人**: ______
- **完成日期**: ______

### Step 1.1.7: 性能测试
- [ ] 建立重构前性能基准
- [ ] 建立重构后性能基准
- [ ] 对比SQL查询次数（目标：降低≥90%）
- [ ] 对比响应时间P95（目标：提升≥40%）
- [ ] 记录数据库CPU使用率
- [ ] 生成性能报告
- **预计时间**: 1小时
- **负责人**: ______
- **完成日期**: ______

### Step 1.1.8: 代码审查
- [ ] 代码规范检查
- [ ] 异常处理检查
- [ ] 日志记录检查
- [ ] 注释完整性检查
- [ ] PMD静态分析通过
- **预计时间**: 1小时
- **负责人**: ______
- **完成日期**: ______

**任务1.1总计**: 13小时（1.6天）

---

## ✅ 任务1.2: TaskController N+1重构

### Step 1.2.1: 分析任务关联的用户ID
- [ ] 识别所有用户ID字段
- [ ] 分析嵌套转换场景
- [ ] 识别子任务、依赖任务的用户ID
- [ ] 识别评论、活动的用户ID
- **预计时间**: 30分钟

### Step 1.2.2: 创建用户ID收集方法
- [ ] 创建collectUserIdsFromTasks方法
- [ ] 处理嵌套任务的用户ID收集
- [ ] 编写单元测试
- **预计时间**: 1小时

### Step 1.2.3: 重构convertToTaskResponse
- [ ] 修改方法签名
- [ ] 移除getById调用
- [ ] 评估commentCount、subtaskCount查询优化
- [ ] 编写测试
- **预计时间**: 2小时

### Step 1.2.4: 重构convertToTaskDetailResponse
- [ ] 处理嵌套任务转换（传递Map）
- [ ] 处理依赖任务转换
- [ ] 处理评论列表转换
- [ ] 处理活动列表转换
- [ ] 收集所有层级的用户ID
- [ ] 编写测试
- **预计时间**: 3小时

### Step 1.2.5: 重构convertToTaskCommentResponse
- [ ] 修改方法签名
- [ ] 从Map获取用户信息
- [ ] 编写测试
- **预计时间**: 1小时

### Step 1.2.6: 编写测试
- [ ] 测试嵌套任务转换
- [ ] 测试空用户Map处理
- [ ] 测试部分用户不存在
- [ ] 测试详情接口性能
- **预计时间**: 2小时

### Step 1.2.7: 性能测试
- [ ] 测试列表接口
- [ ] 测试详情接口（重点关注）
- [ ] 生成性能报告
- **预计时间**: 1小时

**任务1.2总计**: 11小时（1.4天）

---

## ✅ 任务1.3: TestCaseController N+1重构

### Step 1.3.1: 识别用户ID字段
- [ ] creatorId
- [ ] assigneeId
- [ ] reviewerId
- [ ] lastExecutedById
- **预计时间**: 30分钟

### Step 1.3.2: 创建用户ID收集方法
- [ ] 创建collectUserIdsFromTestCases方法
- [ ] 处理多个用户ID字段
- [ ] 编写测试
- **预计时间**: 1小时

### Step 1.3.3: 重构convertToTestCaseResponse
- [ ] 修改方法签名
- [ ] 移除所有getById调用（4个）
- [ ] 从Map获取用户信息
- [ ] 编写测试
- **预计时间**: 2小时

### Step 1.3.4: 重构convertToTestCaseDetailResponse
- [ ] 处理详情中的所有用户ID字段
- [ ] 编写测试
- **预计时间**: 1.5小时

### Step 1.3.5: 重构convertToExecutionHistoryResponse
- [ ] 识别执行历史中的用户ID
- [ ] 重构方法
- [ ] 编写测试
- **预计时间**: 1.5小时

### Step 1.3.6: 重构调用方代码
- [ ] 更新listTestCases方法
- [ ] 更新getTestCaseDetail方法
- [ ] 批量查询用户
- **预计时间**: 1小时

### Step 1.3.7: 编写测试
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能测试
- **预计时间**: 1.5小时

**任务1.3总计**: 9小时（1.1天）

---

## ✅ 任务1.4: DocumentVersionResponse DTO重构

### Step 1.4.1: 查找所有调用方
- [ ] 搜索fromEntityWithUser调用
- [ ] 记录所有调用位置
- [ ] 分析调用上下文
- **预计时间**: 30分钟

### Step 1.4.2: 在Service层创建批量转换方法
- [ ] 创建convertToResponseListWithUser方法
- [ ] 实现用户ID收集逻辑
- [ ] 实现批量查询逻辑
- [ ] 实现DTO转换逻辑
- [ ] 编写单元测试
- **预计时间**: 2小时

### Step 1.4.3: 更新所有调用方
- [ ] 替换所有fromEntityWithUser调用
- [ ] 更新方法签名
- [ ] 验证功能正确性
- **预计时间**: 1小时

### Step 1.4.4: 移除DTO中的fromEntityWithUser方法
- [ ] 注释掉旧方法（暂不删除，作为备份）
- [ ] 添加@Deprecated注解（如果需要保留）
- [ ] 更新Javadoc说明
- **预计时间**: 30分钟

### Step 1.4.5: 编写测试
- [ ] 测试Service层的新方法
- [ ] 测试空列表处理
- [ ] 测试用户不存在的情况
- **预计时间**: 1小时

**任务1.4总计**: 5小时（0.6天）

---

## ✅ 任务1.5: 性能基准测试和监控

### Step 1.5.1: 建立重构前性能基准
- [ ] 配置性能测试工具
- [ ] 设计测试场景（小/中/大数据量）
- [ ] 执行基准测试
- [ ] 记录指标（SQL次数、响应时间、CPU）
- [ ] 生成基准报告
- **预计时间**: 2小时

### Step 1.5.2: 建立重构后性能基准
- [ ] 执行相同场景测试
- [ ] 记录指标
- [ ] 生成测试报告
- **预计时间**: 2小时

### Step 1.5.3: 对比分析
- [ ] 计算性能提升百分比
- [ ] 生成对比报告
- [ ] 验证是否达到目标（SQL降低≥90%，响应时间提升≥40%）
- **预计时间**: 1小时

### Step 1.5.4: 设置监控告警
- [ ] 配置SQL查询次数监控
- [ ] 配置响应时间P95监控
- [ ] 配置慢查询告警
- [ ] 测试告警触发
- **预计时间**: 1小时

**任务1.5总计**: 6小时（0.75天）

---

# 🟡 任务组2: WebSocket异常处理细化（中优先级）

## ✅ 任务2.1: WebSocket异常处理优化

### Step 2.1.1: 分析现有异常处理
- [ ] 识别所有泛型Exception捕获点
- [ ] 分析NotificationWebSocketHandler
- [ ] 分析DefaultWebSocketSessionHandler
- [ ] 分析WebSocketSessionManager
- [ ] 创建问题清单
- **预计时间**: 1小时

### Step 2.1.2: 细化handleMessage异常处理
- [ ] 识别可能抛出的具体异常类型
- [ ] 重构为具体异常捕获
- [ ] 添加适当的错误处理和日志
- [ ] 编写测试
- **预计时间**: 1小时

### Step 2.1.3: 细化getUserIdFromSession异常处理
- [ ] 分析异常场景（NullPointerException、IllegalArgumentException等）
- [ ] 重构异常处理
- [ ] 编写测试
- **预计时间**: 1小时

### Step 2.1.4: 重构parseUserIdFromToken
- [ ] 创建WebSocketAuthService
- [ ] 实现parseUserIdFromToken方法
- [ ] 处理具体异常类型（ExpiredJwtException、MalformedJwtException等）
- [ ] 创建自定义WebSocketAuthException
- [ ] 更新调用方
- [ ] 编写测试
- **预计时间**: 1小时

### Step 2.1.5: 编写测试
- [ ] 测试无效Token处理
- [ ] 测试过期Token处理
- [ ] 测试网络IO异常处理
- [ ] 测试JSON解析错误处理
- [ ] 测试覆盖率达到≥90%
- **预计时间**: 1小时

### Step 2.1.6: 代码审查和PMD检查
- [ ] 代码审查
- [ ] 运行PMD静态分析
- [ ] 验证无AvoidCatchingGenericException警告
- [ ] 修复所有问题
- **预计时间**: 30分钟

**任务2.1总计**: 5.5小时（0.7天）

---

# 🟢 任务组3: 日志审查（低优先级）

## ✅ 任务3.1: 日志级别和内容审查

### Step 3.1.1: 扫描所有日志语句
- [ ] 使用grep查找所有log调用
- [ ] 统计日志级别分布
- [ ] 生成日志清单
- [ ] 识别潜在问题
- **预计时间**: 2小时

### Step 3.1.2: 检查敏感信息泄露
- [ ] 搜索password关键词
- [ ] 搜索token关键词
- [ ] 搜索secret关键词
- [ ] 搜索apiKey关键词
- [ ] 识别敏感信息泄露位置
- [ ] 制定脱敏方案
- **预计时间**: 2小时

### Step 3.1.3: 审查日志级别合理性
- [ ] 检查DEBUG日志（应该用于开发调试）
- [ ] 检查INFO日志（应该记录关键业务流程）
- [ ] 检查WARN日志（应该记录潜在问题）
- [ ] 检查ERROR日志（应该记录严重错误）
- [ ] 识别级别不当的日志
- [ ] 创建修改清单
- **预计时间**: 2小时

### Step 3.1.4: 优化日志内容
- [ ] 改进日志消息清晰度
- [ ] 添加上下文信息
- [ ] 统一日志格式
- [ ] 应用修改
- **预计时间**: 2小时

### Step 3.1.5: 编写日志规范文档
- [ ] 编写日志级别使用指南
- [ ] 编写敏感信息处理规范
- [ ] 编写日志格式标准
- [ ] 添加到工程规范文档
- **预计时间**: 1小时

**任务3.1总计**: 9小时（1.1天）

---

## 📊 总体工作量统计

| 任务组 | 工作量（小时） | 工作量（天） |
|--------|--------------|------------|
| 任务组1: N+1重构 | 44 | 5.5 |
| 任务组2: WebSocket异常处理 | 5.5 | 0.7 |
| 任务组3: 日志审查 | 9 | 1.1 |
| **总计** | **58.5** | **7.3** |

**考虑到缓冲时间（20%）**: 约9天（1.8周）

---

## 🎯 里程碑

| 里程碑 | 任务 | 完成日期 | 状态 |
|--------|------|---------|------|
| **M1: ChangeRequest重构完成** | 任务1.1 | ______ | ⬜ |
| **M2: Task重构完成** | 任务1.2 | ______ | ⬜ |
| **M3: TestCase重构完成** | 任务1.3 | ______ | ⬜ |
| **M4: DTO重构完成** | 任务1.4 | ______ | ⬜ |
| **M5: 性能基准测试完成** | 任务1.5 | ______ | ⬜ |
| **M6: WebSocket异常处理完成** | 任务2.1 | ______ | ⬜ |
| **M7: 日志审查完成** | 任务3.1 | ______ | ⬜ |
| **M8: 全部完成** | 所有任务 | ______ | ⬜ |

---

## 📝 备注

### 任务优先级说明
- 🔴 **高优先级**: 必须立即开始，严重影响性能
- 🟡 **中优先级**: 应该尽快完成，影响代码质量
- 🟢 **低优先级**: 可以延后，不影响核心功能

### 状态说明
- ⬜ 待开始
- 🟡 进行中
- ✅ 已完成
- ❌ 已取消
- ⚠️ 受阻

### 更新日志
- 2025-10-30: 创建初始清单

---

**使用说明**: 
1. 每个任务完成后，勾选对应的复选框
2. 填写负责人和完成日期
3. 如有问题，在备注中说明
4. 定期更新状态和进度

