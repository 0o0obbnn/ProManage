<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.promanage.service.mapper.DocumentMapper">

    <!-- 搜索文档（用于搜索服务） -->
    <select id="searchDocuments" resultType="com.promanage.service.dto.SearchResultDTO">
        SELECT d.id, d.title, d.content, d.project_id as projectId, d.creator_id as creatorId,
               d.create_time as createTime, d.update_time as updateTime,
               u.username as creatorName, p.name as projectName 
        FROM tb_document d
        LEFT JOIN tb_user u ON d.creator_id = u.id
        LEFT JOIN tb_project p ON d.project_id = p.id
        WHERE d.deleted = false
        <if test="keyword != null and keyword != ''">
            AND (d.title LIKE CONCAT('%', #{keyword}, '%') OR d.content LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="projectId != null">
            AND d.project_id = #{projectId}
        </if>
        ORDER BY d.create_time DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 统计搜索文档数量 -->
    <select id="countSearchDocuments" resultType="java.lang.Long">
        SELECT COUNT(*) FROM tb_document d
        WHERE d.deleted = false
        <if test="keyword != null and keyword != ''">
            AND (d.title LIKE CONCAT('%', #{keyword}, '%') OR d.content LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <if test="projectId != null">
            AND d.project_id = #{projectId}
        </if>
    </select>

    <!-- 根据关键词获取不重复的文档标题（用于搜索建议） -->
    <select id="getDistinctTitlesByKeyword" resultType="string">
        SELECT DISTINCT title FROM tb_document
        WHERE deleted = false AND title LIKE CONCAT('%', #{keyword}, '%')
        ORDER BY create_time DESC
        LIMIT 10
    </select>

</mapper>